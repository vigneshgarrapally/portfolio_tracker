{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Fetch Latest Stock Prices (Zerodha)</h1>
    <a href="{{ url_for('stocks') }}" class="btn btn-secondary">
        <i class="bi bi-x-lg me-1"></i> Cancel
    </a>
</div>

<div class="card">
    <div class="card-body">
        <h5 class="card-title">Step 1: Log in to Kite</h5>
        <p>Click the link below to log in to your Zerodha Kite account. It will open in a new tab.</p>
        <p class="text-muted small"><strong>Note:</strong> You must have a Redirect URL (e.g., <code>https://google.com</code>) configured in your Kite App settings.</p>
        <a href="{{ login_url }}" target="_blank" class="btn btn-primary mb-3">
            <i class="bi bi-box-arrow-up-right me-1"></i> Open Zerodha Login Page
        </a>
        
        <hr>

        <h5 class="card-title mt-4">Step 2: Paste Your Request Token</h5>
        <p>After logging in, Zerodha will redirect you to your "Redirect URL". The URL in your browser's address bar will look something like this:</p>
        <p class="text-muted small"><code>https://your-redirect-url.com/?status=success&amp;request_token=<strong>ABCdEfgHIjK...</strong></code></p>
        <p>Copy the entire <code>request_token</code> value (the long string of letters and numbers) from that URL and paste it below.</p>

        <form action="{{ url_for('fetch_stock_prices') }}" method="POST"
              onsubmit="this.btn.disabled=true; this.btn.innerHTML='<span class=\'spinner-border spinner-border-sm\' role=\'status\' aria-hidden=\'true\'></span> Processing...';">
            <div class="mb-3">
                <label for="request_token" class="form-label">Request Token</label>
                <input type="text" class="form-control" id="request_token" name="request_token" required>
            </div>
            <button type="submit" name="btn" class="btn btn-success">
                <i class="bi bi-check-circle me-1"></i> Generate Session & Fetch Holdings
            </button>
        </form>
    </div>
</div>
{% endblock %}