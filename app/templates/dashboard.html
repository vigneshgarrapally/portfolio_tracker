{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Dashboard</h1>
</div>

<div class="card mb-3">
    <div class="card-body">
        <form method="GET" action="{{ url_for('dashboard') }}" class="row g-3 align-items-center">
            <div class="col-auto">
                <label for="user_id" class="col-form-label">Filter by User:</label>
            </div>
            <div class="col-auto">
                <select class="form-select" id="user_id" name="user_id" onchange="this.form.submit()">
                    <option value="">All Users</option>
                    {% for user in all_users %}
                    <option value="{{ user.id }}" {{ 'selected' if user.id == selected_user_id }}>
                        {{ user.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Clear</a>
            </div>
        </form>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-header">Total Investment</div>
            <div class="card-body fs-5 fw-bold">{{ summary.total_investment | inr }}</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-header">Total Current Value</div>
            <div class="card-body fs-5 fw-bold">{{ summary.total_current_value | inr }}</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-header">Overall P&L</div>
            <div class="card-body fs-5 fw-bold {% if summary.total_pnl > 0 %}text-success{% elif summary.total_pnl < 0 %}text-danger{% endif %}">
                {{ summary.total_pnl | inr }}
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-header">Overall XIRR</div>
            <div class="card-body fs-5 fw-bold {% if summary.overall_xirr > 0 %}text-success{% elif summary.overall_xirr < 0 %}text-danger{% endif %}">
                {{ "%.2f"|format(summary.overall_xirr) }} %
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Allocation (Current Value)</h5>
            </div>
            <div class="card-body">
                <canvas id="currentPieChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Invested vs. Current Value</h5>
            </div>
            <div class="card-body">
                <canvas id="investedVsCurrentChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Allocation (Invested)</h5>
            </div>
            <div class="card-body">
                <canvas id="investedPieChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Performance (XIRR)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Asset Class</th>
                                <th class="text-end">Invested</th>
                                <th class="text-end">Current</th>
                                <th class="text-end">XIRR</th>
                            </tr>
                        </thead>
                        <tbody>
                           {% for asset, data in asset_data.items() %}
                            <tr class="align-middle">
                                <td class="fw-bold">{{ asset | capitalize }}</td>
                                <td class="text-end">
                                    {{ data.investment | inr }}
                                    {% if summary.total_investment > 0 %}
                                        {% set invested_pct = (data.investment / summary.total_investment) * 100 %}
                                        <small class="text-muted d-block">({{ "%.2f"|format(invested_pct) }}%)</small>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {{ data.current_value | inr }}
                                    {% if summary.total_current_value > 0 %}
                                        {% set current_pct = (data.current_value / summary.total_current_value) * 100 %}
                                        <small class="text-muted d-block">({{ "%.2f"|format(current_pct) }}%)</small>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold {% if data.xirr > 0 %}text-success{% elif data.xirr < 0 %}text-danger{% endif %}">
                                    {{ "%.2f"|format(data.xirr) }} %
                                </td>
                            </tr>
                            {% endfor %}
                            <tr class="table-light fw-bold">
                                <td>Overall Total</td>
                                <td class="text-end">
                                    {{ summary.total_investment | inr }}
                                    {% if summary.total_investment > 0 %}
                                    <small class="text-muted d-block">(100.00%)</small>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {{ summary.total_current_value | inr }}
                                     {% if summary.total_current_value > 0 %}
                                    <small class="text-muted d-block">(100.00%)</small>
                                    {% endif %}
                                </td>
                                <td class="text-end {% if summary.overall_xirr > 0 %}text-success{% elif summary.overall_xirr < 0 %}text-danger{% endif %}">
                                    {{ "%.2f"|format(summary.overall_xirr) }} %
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script>

    // Pass data from Flask to JavaScript
    const assetData = {{ asset_data | tojson }};
    const labels = Object.keys(assetData).map(s => s.charAt(0).toUpperCase() + s.slice(1));
    
    // 1. REGISTER THE PLUGIN ONCE (Best practice)
    Chart.register(ChartDataLabels); // <-- ADDED

    // Helper function for consistent pie charts
    function createPieChart(ctx, label, dataValues) {
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: dataValues,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)', // Gold
                        'rgba(54, 162, 235, 0.8)', // Real Estate
                        'rgba(255, 206, 86, 0.8)', // Mutual Funds
                        'rgba(75, 192, 192, 0.8)', // Stocks
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    // 2. DATALABELS CONFIGURATION
                    datalabels: { // <-- ADDED
                        color: '#fff', // White text for better contrast
                        formatter: (value, context) => {
                            // Calculate the total sum of all data values
                            let sum = 0;
                            let dataArr = context.chart.data.datasets[0].data;
                            dataArr.map(data => {
                                sum += data;
                            });
                            // Calculate the percentage
                            let percentage = (value * 100 / sum).toFixed(1) + "%";
                            return percentage;
                        },
                        font: {
                            weight: 'bold'
                        }
                    }
                }
            }
        });
    }
    // Run after the page loads
    document.addEventListener('DOMContentLoaded', () => {

        // 1. Invested vs Current Bar Chart
        const barCtx = document.getElementById('investedVsCurrentChart').getContext('2d');
        const investedData = labels.map(label => assetData[label.toLowerCase()].investment);
        const currentData = labels.map(label => assetData[label.toLowerCase()].current_value);

        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Invested Value',
                        data: investedData,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Current Value',
                        data: currentData,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // <-- ADDED
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });

        // 2. Allocation by Current Value Pie Chart
        const currentPieCtx = document.getElementById('currentPieChart').getContext('2d');
        createPieChart(currentPieCtx, 'Current Value', currentData);

        // 3. Allocation by Invested Value Pie Chart
        const investedPieCtx = document.getElementById('investedPieChart').getContext('2d');
        createPieChart(investedPieCtx, 'Invested Value', investedData);

    });
</script>
{% endblock %}