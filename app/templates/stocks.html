{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Stocks</h1>
    <div>
        <a href="{{ url_for('fetch_stock_prices') }}" class="btn btn-info me-2">
            <i class="bi bi-cloud-download me-1"></i> Fetch Latest Price
        </a>
        <a href="{{ url_for('upload_stock_csv') }}" class="btn btn-success me-2">
            <i class="bi bi-upload me-1"></i> Upload CSV
        </a>
        <a href="{{ url_for('add_stock') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> Add Stock
        </a>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <form method="GET" action="{{ url_for('stocks') }}" class="row g-3 align-items-center">
            <div class="col-auto">
                <label for="user_id" class="col-form-label">Filter by User:</label>
            </div>
            <div class="col-auto">
                <select class="form-select" id="user_id" name="user_id" onchange="this.form.submit()">
                    <option value="">All Users</option>
                    {% for user in all_users %}
                    <option value="{{ user.id }}" {{ 'selected' if user.id == selected_user_id }}>
                        {{ user.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('stocks') }}" class="btn btn-outline-secondary">Clear</a>
            </div>
        </form>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-header">Total Investment</div>
            <div class="card-body">₹{{ "%.2f"|format(summary.total_investment) }}</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-header">Current Value</div>
            <div class="card-body">₹{{ "%.2f"|format(summary.total_current_value) }}</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-header">Total P&L</div>
            <div class="card-body {% if summary.total_pnl > 0 %}text-success{% elif summary.total_pnl < 0 %}text-danger{% endif %}">
                ₹{{ "%.2f"|format(summary.total_pnl) }}
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-header">Overall XIRR</div>
            <div class="card-body {% if summary.overall_xirr > 0 %}text-success{% elif summary.overall_xirr < 0 %}text-danger{% endif %}">
                {{ "%.2f"|format(summary.overall_xirr) }} %
            </div>
        </div>
    </div>
</div>

<h4 class="mt-4">Active Holdings</h4>
<div class="card mb-3">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Stock</th>
                        <th class="text-end">Current Units</th>
                        <th class="text-end">Avg. Buy Price</th>
                        <th class="text-end">Current Price</th>
                        <th class="text-end">Investment</th>
                        <th class="text-end">Current Value</th>
                        <th class="text-end">Unrealized P&L</th>
                        <th class="text-end">XIRR</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock_id, data in active_holdings.items() %}
                    <tr class="align-middle">
                        <td>
                            <div>{{ data.stock.symbol }}</div>
                            <small class="text-muted">{{ data.stock.isin }}</small>
                        </td>
                        <td class="text-end fw-bold">{{ "%.4f"|format(data.current_units) }}</td>
                        <td class="text-end">₹{{ "%.2f"|format(data.avg_buy_price) }}</td>
                        <td class="text-end">₹{{ "%.2f"|format(data.current_price) }}</td>
                        <td class="text-end">₹{{ "%.2f"|format(data.investment) }}</td>
                        <td class="text-end">₹{{ "%.2f"|format(data.current_value) }}</td>
                        <td class="text-end {% if data.unrealized_pnl > 0 %}text-success{% elif data.unrealized_pnl < 0 %}text-danger{% endif %}">
                            {{ "%.2f"|format(data.unrealized_pnl) }}
                        </td>
                        <td class="text-end {% if data.xirr > 0 %}text-success{% elif data.xirr < 0 %}text-danger{% endif %}">
                            {{ "%.2f"|format(data.xirr) }} %
                        </td>
                        <td class="text-end">
                            <a href="{{ url_for('view_stock', stock_id=stock_id, user_id=selected_user_id) }}" class="btn btn-sm btn-outline-primary" title="View/Add Transactions">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="{{ url_for('edit_stock', stock_id=stock_id) }}" class="btn btn-sm btn-outline-secondary" title="Edit Stock Details">
                                <i class="bi bi-pencil"></i>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="9" class="text-center py-4 text-muted">No active stock holdings found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<h5 class="mt-4">
    <a data-bs-toggle="collapse" href="#pastHoldings" role="button" aria-expanded="false" aria-controls="pastHoldings" class="text-decoration-none">
        Past Holdings <i class="bi bi-chevron-down"></i>
    </a>
</h5>
<div class="collapse" id="pastHoldings">
    <div class="card mb-3">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Stock</th>
                            <th class="text-end">Realized P&L</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stock_id, data in inactive_holdings.items() %}
                        <tr class="align-middle text-muted">
                            <td>
                                <div>{{ data.stock.symbol }}</div>
                                <small>{{ data.stock.isin }}</small>
                            </td>
                            <td class="text-end {% if data.realized_pnl > 0 %}text-success{% elif data.realized_pnl < 0 %}text-danger{% endif %}">
                                ₹{{ "%.2f"|format(data.realized_pnl) }}
                            </td>
                            <!-- --- MODIFIED ACTIONS --- -->
                            <td class="text-end">
                                <a href="{{ url_for('view_stock', stock_id=stock_id, user_id=selected_user_id) }}" class="btn btn-sm btn-outline-primary" title="View Transactions">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{{ url_for('edit_stock', stock_id=stock_id) }}" class="btn btn-sm btn-outline-secondary" title="Edit Stock Details">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <!-- Add Delete button for inactive stocks with no transactions -->
                                {% if data.current_units == 0 %}
                                <form action="{{ url_for('delete_stock', stock_id=stock_id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete stock {{ data.stock.symbol }}? This fails if transactions exist.');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Stock">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </td>
                            <!-- ------------------------ -->
                        </tr>
                        {% else %}
                        <tr><td colspan="3" class="text-center py-3 text-muted">No past holdings found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}